name: CI - Build + SAST + DAST

on:
  push:
    branches: [ main ]
  repository_dispatch:
    types: [run-security]   # optional trigger from another repo

jobs:
  sast:
    name: SAST (Bandit + Semgrep)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Run Bandit (Python SAST)
        uses: PyCQA/bandit-action@v2
        with:
          args: "-r . -f json -o bandit-report.json"

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v2
        with:
          config: "p/ci"

  build-and-dast:
    name: Build image and DAST (ZAP baseline)
    runs-on: ubuntu-latest
    needs: sast
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t calculator:ci .

      - name: Run app container (background)
        run: |
          docker run -d --name calc-ci -p 8000:5000 calculator:ci
          sleep 3

      - name: Wait for app to be ready
        run: |
          for i in {1..10}; do
            if curl -sSf http://localhost:8000/ >/dev/null; then
              echo "up"
              break
            fi
            sleep 2
          done

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:8000'
          fail_on_alert_level: 'High'

      - name: Stop container
        if: always()
        run: |
          docker stop calc-ci && docker rm calc-ci || true
